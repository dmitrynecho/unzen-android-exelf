import java.util.regex.Pattern

def tasksToStrings = new LinkedHashMap<String, String>()
String genTasksGraphTaskNameAssemble = "alephTasksGraphAssemble"
String genTasksGraphTaskNameBundle = "alephTasksGraphBundle"
File reportAssemble = file("$rootDir/docs/tasks-graph-assemble.txt")
File reportBundle = file("$rootDir/docs/tasks-graph-bundle.txt")

ext.stabilizePathsPattern = Pattern.compile(
        "(.+)(/build/intermediates/cxx/)(.+)(/.{8}/)(logs|obj/local)(.+)")

@SuppressWarnings('GrMethodMayBeStatic')
String stabilizePaths(String output) {
    if (!output.contains("/build/intermediates/cxx/")) {
        return output
    }
    // /build/intermediates/cxx/Release/5h6q5c2l/logs/arm64-v8a
    // /build/intermediates/cxx/Release/5h6q5c2l/obj/local/arm64-v8a
    output = output.replaceAll(stabilizePathsPattern, "\$1\$2\$3/<hash>/\$5\$6")
    return output
}

String taskToString(Task task) {
    StringBuffer taskInfo = new StringBuffer()
    taskInfo << task.path
    def dependsOnList = new LinkedList<String>()
    task.dependsOn.forEach { dep ->
        //dependsOnList.add("D: " + dep)
    }
    if (!dependsOnList.isEmpty()) {
        taskInfo << "\n" << dependsOnList.sort().join("\n")
    }
    task.inputs.eachWithIndex { it, i ->
        if (it instanceof File) {
            taskInfo << "\nI: ${it.absolutePath}"
        } else {
            String input = it.toString()
            if (!input.startsWith("org.gradle.api.internal.tasks.DefaultTaskInputs")) {
                taskInfo << "\nI: $input"
            }
        }
    }
    task.outputs.files.eachWithIndex { File file, i ->
        taskInfo << "\nO: ${stabilizePaths(file.absolutePath)}"
    }
    return taskInfo.toString()
}

afterEvaluate { Project project ->
    gradle.taskGraph.whenReady { TaskExecutionGraph taskExecutionGraph ->
        tasksToStrings.clear()
        File reportFile = null
        taskExecutionGraph.getAllTasks().each { Task task ->
            String taskAsString = taskToString(task)
            tasksToStrings.put(task.path, taskAsString)
            if (task.name == genTasksGraphTaskNameAssemble) {
                reportFile = reportAssemble
            } else if (task.name == genTasksGraphTaskNameBundle) {
                reportFile = reportBundle
            }
        }
        if (reportFile != null) {
            if (!reportFile.exists()) {
                throw new GradleException()
            }
            reportFile.text = tasksToStrings.values().join("\n")
        }
    }
}

tasks.register(genTasksGraphTaskNameAssemble) {
    group = "aleph"
    dependsOn tasks.named("assemble")
}

tasks.register(genTasksGraphTaskNameBundle) {
    group = "aleph"
    dependsOn tasks.named("bundle")
}

//noinspection GrDeprecatedAPIUsage TODO: delete.
gradle.taskGraph.afterTask { Task task ->
    //noinspection GroovyConstantIfStatement
    if (true) {
        //return
    }
    String taskAsString = taskToString(task)
    String expected = tasksToStrings.get(task.path)
    if (taskAsString != expected) {
        throw new GradleException(task.path)
    }
}